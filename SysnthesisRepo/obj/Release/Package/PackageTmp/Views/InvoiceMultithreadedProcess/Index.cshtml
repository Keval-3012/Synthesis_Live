@model IEnumerable<EntityModels.Models.ApiKeyConfiguartion>
@using EntityModels.Models;
@using Utility;

@{

    Layout = "~/Views/Shared/AdminMaster.cshtml";
}
<style>
    #apikeynamestore {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 9999;
        opacity: 1;
        background: #010101b3;
    }

    #bucketsizestore {
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 9999;
        opacity: 1;
        background: #010101b3;
    }

    .saa {
        background: #ff4948 !important;
        color: #fff !important;
        border: 1px solid #ff4948 !important;
        width: 100%;
        margin-bottom: 5px;
    }

    .modal-backdrop {
        z-index: 0 !important;
    }

    .e-icons.e-file-delete-btn {
        display: none !important;
    }
    .toast.toast-error {
        background: #e53939;
        font-size: 14px;
    }
    .statustempactive {
        background-color: #ccffcc;
        border-radius: 3px;
        padding: 3px 8px;
        font-size: 16px;
        font-weight:500;
        color: #00cc00;
    }

    .statustempinactive {
        background-color: #ffd7cc;        
        border-radius: 3px;
        padding: 3px 8px;
        font-size: 16px;
        font-weight: 500;
        color: #e60000;
    }
</style>


@*<div class="header-small special_bg">
        <h3>Key Configuration <a href="@Url.Action("Create", "InvoiceMultithreadedProcess")" class="pull-right addstore" data-toggle="tooltip" data-placement="bottom" data-original-title="Add"><img src="~/Content/Admin/images/plus.svg" alt="" /></a></h3>

    </div>*@

<div class="text-align-right">
    <a class="btn btn-info btn-lg" onclick="OpenPopupAPikeyModel();"><i class="" aria-hidden="true"></i>Add Api Key</a>
    <a class="btn btn-info btn-lg" onclick="OpenPopupBucketModel();"><i class="" aria-hidden="true"></i>Bucket Size</a>
</div>

<div class="modal fade" id="apikeynamestore" role="dialog">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="margin-top:14%;width:600px;">
            <div class="modal-header text-center">
                <button type="button" onclick="reloadpage()" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add Api Key</h4>
            </div>
            <div class="modal-body modal-up-scroll">
                <div class="control-section">
                    <div class="control_wrapper">
                        <label>
                            API Key Name <span class="highlight">*</span>
                        </label>
                        <input type="text" id="APIKeyName" class="form-control" maxlength="200" autocomplete="off" required />
                        <input type="hidden" id="APIKeyId" />
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" onclick="reloadpage()" class="buttonbox btncancel" data-dismiss="modal">Cancel</button>
                <button type="button" onclick="SaveApiKeyFile()" class="buttonbox btnsubmit" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bucketsizestore" role="dialog">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="margin-top:14%;width:600px;">
            <div class="modal-header text-center">
                <button type="button" onclick="reloadpage()" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Bucket Size</h4>
            </div>
            <div class="modal-body modal-up-scroll">
                <div class="control-section">
                    <div class="control_wrapper">
                        <label>
                            Bucket Size <span class="highlight">*</span>
                        </label>
                        <input type="number" id="BucketSize" class="form-control" maxlength="5" autocomplete="off" min="1" required oninput="validateBucketSize()" />
                        <input type="hidden" id="BucketId" />
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" onclick="reloadpage()" class="buttonbox btncancel" data-dismiss="modal">Cancel</button>
                <button type="button" onclick="SaveBucketSize()" class="buttonbox btnsubmit" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>


<div class="datagrid martop15">
    <div class="table-responsive">

        <table class="table table-striped table-hover">

            <thead>
                <tr>
                    <th width="40%"><a class="textred" style="color:#fff; text-decoration:none; cursor:pointer;">API Key Name</a></th>
                    <th width="20%"><a class="textred" style="color:#fff; text-decoration:none; cursor:pointer;">Bucket Size</a></th>
                    <th width="20%"><a class="textred" style="color:#fff; text-decoration:none; cursor:pointer;">Status</a></th>
                    <th width="20%"><a class="textred" style="color:#fff; text-decoration:none; cursor:pointer;">Action</a></th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Count() > 0)
                {
                    foreach (var item in Model)
                    {
                        <tr class="even">
                            <td style="width:60%">@item.APIKeyName</td>
                            <td>@item.BucketSize</td>
                            @if (item.Status == 0)
                            {
                                <td><span class="statustempactive">Active</span></td>
                            }
                            else if (item.Status == 1)
                            {
                                <td><span class="statustempinactive">Key Expired</span></td>
                            }
                            <td>
                                <a href="#" onclick="return EditApikey(@item.APIKeyId);" data-toggle="tooltip" data-placement="top" data-original-title="Edit"><img src="../Content/Admin/images/edit-2.svg" alt="" /> </a>
                                @{
                                    var APIKeyId = @item.APIKeyId + "D";
                                }
                                <a href="#" onclick="return ComfirmDelete(@item.APIKeyId);" data-toggle="tooltip" data-placement="top" data-original-title="Delete"><img src="../Content/Admin/images/trash-2.svg" alt="" /> </a>
                                <div id="@APIKeyId" class="divIDClass modal-popup modal-danger modal-message" style="position: fixed;  left:45%; width:300px; top: 10px; display:none">
                                    <div class="modal-content ">
                                        <div class="modal-header text-center">
                                            <i class="glyphicon glyphicon-trash"></i>
                                        </div>
                                        <div class="modal-title">Message</div>
                                        <div class="modal-body ">Are you sure want to delete this User?</div>
                                        <div class="modal-footer" style="text-align:center">
                                            <a class="btn btn-danger" onclick="Delete(@item.APIKeyId);">Ok </a>
                                            <a class="btn" data-dismiss="modal" onclick="closemodal()">Cancel</a>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center">
                            No Data Available
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>
<script>
    function ComfirmDelete(ID) {
        var DivId = "#" + ID + "D";
        $(DivId).show();
    }

    function Delete(ID) {
        $.ajax({
            url: ROOTURL + "/InvoiceMultithreadedProcess/Delete",
            type: 'POST',
            data: { Id: ID },
            success: function (response) {
                if (response.success == "Delete") {
                    $(".divIDClass").hide();
                    toastr.success('API Key Deleted Successfully.');                    
                    setTimeout(function () {
                        window.location.reload();
                    }, 700);
                }
            },
            error: function () {
                Loader(0);
            }
        });
    }

    function closemodal() {
        $(".divIDClass").hide();
    }


    function OpenPopupAPikeyModel() {
        $('#apikeynamestore').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });
    }
    function OpenPopupBucketModel() {
        $('#bucketsizestore').modal({
            backdrop: 'static',
            keyboard: true,
            show: true
        });

        $.ajax({
            url: ROOTURL + "/InvoiceMultithreadedProcess/EditBucketSize",
            type: 'POST',
            success: function (response) {
                if (response.bucketid != "") {
                    $("#bucketsizestore").show();
                    $("#BucketSize").val(response.bucketsize);
                    $("#BucketId").val(response.bucketid);
                }
            },
            error: function () {
                Loader(0);
            }
        });
    }

    function SaveBucketSize() {
        var bucketid = $("#BucketId").val();
        var bucketsize = $("#BucketSize").val();
        $.ajax({
            url: ROOTURL + "/InvoiceMultithreadedProcess/UpdateBucketSize",
            type: 'POST',
            data: { bucketid: bucketid, bucketsize: bucketsize },
            success: function (response) {
                if (response.success == "Update") {
                    $("#bucketsizestore").hide();
                    toastr.success('Bucket Size Updated Successfully.');
                    window.location.reload();
                }
            },
            error: function () {
                Loader(0);
            }
        });
    }

    function SaveApiKeyFile() {       
        var apikey = $("#APIKeyName").val();
        var apikeyid = $("#APIKeyId").val();
        if (apikey != "") {
            if (apikeyid == "") {
                $.ajax({
                    url: ROOTURL + "/InvoiceMultithreadedProcess/Create",
                    type: 'POST',
                    data: { apikey: apikey },
                    success: function (response) {
                        if (response.success == "Create") {
                            $("#apikeynamestore").hide();
                            toastr.success('API Key Created Successfully.');
                            window.location.reload();
                        }
                    },
                    error: function () {
                        Loader(0);
                    }
                });
            }
            else {               
                $.ajax({
                    url: ROOTURL + "/InvoiceMultithreadedProcess/Update?apikeyid=" + apikeyid + "&keyname=" + apikey,
                    type: 'POST',
                    data: { apikeyid: apikeyid, apikey: apikey },
                    success: function (response) {
                        if (response.success == "Update") {
                            $("#apikeynamestore").hide();
                            toastr.success('API Key Updated Successfully.');
                            window.location.reload();
                        }
                    },
                    error: function () {
                        Loader(0);
                    }
                });
            }
        }
        else {
            toastr.error('Please enter API Key.');
        }

    }

    function EditApikey(id) {
        $.ajax({
            url: ROOTURL + "/InvoiceMultithreadedProcess/Edit?id" + id,
            type: 'POST',
            data: { id: id },
            success: function (response) {
                if (response.apikeyid != "") {
                    $('#apikeynamestore').modal({
                        backdrop: 'static',
                        keyboard: true,
                        show: true
                    });
                    $("#APIKeyName").val(response.apikeyname);
                    $("#APIKeyId").val(response.apikeyid);
                }
            },
            error: function () {
                Loader(0);
            }
        });
    }
    function validateBucketSize() {
        var bucketSizeInput = document.getElementById('BucketSize');
        if (bucketSizeInput.value < 0) {
            bucketSizeInput.value = 1;
        }
    }

</script>